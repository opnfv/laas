{% extends "workflow/viewport-element.html" %}
{% load staticfiles %}

{% load bootstrap4 %}

{% block content %}

<div class="text-center">
    <h3>Confirm  Session</h3>
</div>
<div id="vlan_warning"></div>
<form id="vlan_form" action="/wf/workflow/" method="post">
    {% csrf_token %}
    <input id="vlan_input" name="vlan_input" type="hidden"/>
</form>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-auto">
            <pre>{{confirmation_info|escape}}</pre>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div id="form_div" class="text-center p-4">
                <form id="confirmation_form" action="/wf/workflow/" method="post">
                    {% csrf_token %}
                    <div class="d-none">
                    {{form|default:"<p> No Form Loaded</p>"}}
                    </div>
                </form>
                <div class="cform_buttons mx-auto">
                    <button id="confirm_button" class="btn btn-success" onclick="formconfirm()">Confirm</button>
                    <button id="cancel_button" class="btn btn-danger" onclick="formcancel()">Cancel</button>
                </div>
                <div class="d-none">
                    <form id="manager_delete_form" action="/wf/workflow/finish/" method="post">
                        {% csrf_token %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var select = document.getElementById("id_confirm");

    function processResponseText(json)
    {
        var dict = JSON.parse(json);

        if( !dict["redir_url"] ) {
            window.top.refresh_iframe();
        } else {
            top.window.location.href = dict["redir_url"];
        }
    }

    function delete_manager()
    {
        var form = $("#manager_delete_form");
        var formData = form.serialize();
        var req = new XMLHttpRequest();
        req.open("POST", "/wf/workflow/finish/", false);
        req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        req.onerror = function() { alert("problem with cleaning up session"); }
        req.onreadystatechange = function() { if(req.readyState === 4 ) {
                processResponseText(req.responseText);
                }}
        req.send(formData);
    }

    function submitForm()
    {
        var form = $("#confirmation_form");
        var formData = form.serialize();
        var req = new XMLHttpRequest();
        req.open("POST", "/wf/workflow/", false);
        req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        req.onerror = function() { alert("problem submitting confirmation"); }
        req.onreadystatechange = function() { if(req.readyState === 4 ) { delete_manager(); } }
        req.send(formData);
    }


    function formconfirm()
    {
        select.value = "True";
        submitForm();
    }
    function formcancel()
    {
        select.value = "False";
        submitForm();
    }

    var confirmed = {{bypassed|default:"false"}};
    if( confirmed )
    {
        delete_manager();
    }
</script>
{% block element_messages %}

{% endblock element_messages %}
{% endblock content %}
{% block onleave %}
{% endblock %}
